classDiagram
  subgraph Core
    class Component {
      -component_classes
      +register()
      +get_class()
      +from_hash()
      +initialize()
      +type()
      +to_hash()
      +data()
      +update()
    }
    class Entity {
      -id
      -components
      -component_map
      -tags
      -name
      +initialize()
      +add_component()
      +remove_component()
      +has_component?()
      +get_component()
      +add_tag()
      +remove_tag()
      +has_tag?()
      +tags()
      +update()
      +to_hash()
      +method_missing()
      +respond_to_missing?()
    }
    class System {
      -world
      +initialize()
      +update()
      +handle_event()
      +entities_with()
      +emit_event()
      +queue_command()
    }
    class World {
      -entities
      -systems
      -display
      -current_level
      -event_subscribers
      -event_queue
      -command_queue
      +initialize()
      +add_entity()
      +remove_entity()
      +get_entity()
      +find_entity_by_tag()
      +query_entities()
      +add_system()
      +update()
      +queue_command()
      +emit_event()
      +subscribe()
      +unsubscribe()
      +set_level()
      +grid()
      +process_events()
      +process_commands()
      +handle_command()
      +change_level()
      +add_to_inventory()
    }
  end
  subgraph Components
    class Component {
      -component_classes
      +register()
      +get_class()
      +from_hash()
      +initialize()
      +type()
      +to_hash()
      +data()
      +update()
    }
    style Component fill:#ffcccc
    class ConsumableComponent {
      -charges
      -effects
      -auto_identify
      +initialize()
      +type()
      +has_charges?()
      +consume()
      +to_hash()
      +apply_effects()
      +heal_entity()
      +damage_entity()
      +apply_buff()
      +teleport_entity()
    }
    Component <|-- ConsumableComponent
    style ConsumableComponent fill:#ffcccc
    class CurrencyComponent {
      -value
      -currency_type
      +initialize()
      +type()
      +combine()
      +split()
      +display_string()
      +standard_value()
      +to_hash()
    }
    style CurrencyComponent fill:#ffcccc
    class DurabilityComponent {
      -max_durability
      -current_durability
      +initialize()
      +type()
      +decrease()
      +repair()
      +full_repair()
      +usable?()
      +percentage()
      +status()
      +needs_repair?()
      +to_hash()
      +notify_low_durability()
      +notify_repair()
    }
    style DurabilityComponent fill:#ffcccc
    class EffectComponent {
      -active_effects
      +initialize()
      +type()
      +add_effect()
      +remove_effect()
      +remove_effects_by_source()
      +remove_expired_effects()
      +get_effects_by_type()
      +has_active_effects?()
      +get_stat_modifier()
      +update()
      +to_hash()
    }
    style EffectComponent fill:#ffcccc
    class EquippableComponent {
      -slot
      -stat_modifiers
      -equipped
      +initialize()
      +type()
      +equipped?()
      +equip()
      +unequip()
      +to_hash()
      +validate_slot()
      +slot_occupied?()
      +apply_stat_modifiers()
      +remove_stat_modifiers()
    }
    Component <|-- EquippableComponent
    style EquippableComponent fill:#ffcccc
    class InputComponent {
      -move_direction
      -action_triggered
      -action_params
      +initialize()
      +type()
      +set_move_direction()
      +set_action_triggered()
      +action_params()
      +clear()
      +data()
    }
    Component <|-- InputComponent
    style InputComponent fill:#ffcccc
    class InventoryComponent {
      -items
      -max_size
      +initialize()
      +type()
      +full?()
      +add()
      +remove()
      +has?()
      +count()
      +find_by_id()
      +to_hash()
      +find_stackable_item()
    }
    style InventoryComponent fill:#ffcccc
    class ItemComponent {
      -name
      -description
      -item_type
      -weight
      -value
      -stackable
      -stack_size
      +initialize()
      +type()
      +stackable?()
      +increase_stack()
      +decrease_stack()
      +use()
      +to_hash()
      +display_string()
    }
    Component <|-- ItemComponent
    style ItemComponent fill:#ffcccc
    class KeyComponent {
      -key_id
      -lock_type
      -one_time_use
      +initialize()
      +type()
      +matches?()
      +unlock()
      +description()
      +to_hash()
    }
    style KeyComponent fill:#ffcccc
    class MovementComponent {
      -active
      -speed
      +initialize()
      +type()
      +active?()
      +to_hash()
    }
    Component <|-- MovementComponent
    style MovementComponent fill:#ffcccc
    class PositionComponent {
      -row
      -column
      +initialize()
      +type()
      +set_position()
      +to_hash()
    }
    Component <|-- PositionComponent
    style PositionComponent fill:#ffcccc
    class RenderComponent {
      -character
      -color
      -layer
      -entity_type
      +initialize()
      +type()
      +tile()
      +update_appearance()
      +set_layer()
      +set_color()
      +data()
    }
    Component <|-- RenderComponent
    style RenderComponent fill:#ffcccc
    class StairsComponent {
      -found_stairs
      +initialize()
      +type()
      +data()
    }
    Component <|-- StairsComponent
    style StairsComponent fill:#ffcccc
    class TileComponent {
      -tile
      +initialize()
      +type()
      +change_tile()
      +data()
    }
    Component <|-- TileComponent
    style TileComponent fill:#ffcccc
    class TestPositionComponent {
      -row
      -column
      +initialize()
      +type()
    }
    Component <|-- TestPositionComponent
    style TestPositionComponent fill:#ffcccc
  end
  subgraph Systems
    class MessageSystem {
      -logger
      -manager
      -message_queue
      +initialize()
      +setup_panel()
      +render()
      +log_message()
      +log_success()
      +log_warning()
      +log_critical()
      +get_recent_messages()
      +handle_input()
      +toggle_selection_mode()
      +selection_mode?()
      +cleanup()
      +update()
      +handle_event()
      +add_message()
      +process_message_queue()
      +trim_message_queue()
      +importance_value()
    }
    class CollisionSystem {
      -logger
      +initialize()
      +update()
      +handle_event()
      +find_entities_at_position()
      +handle_specific_collisions()
    }
    System <|-- CollisionSystem
    class InputSystem {
      -logger
      +initialize()
      +update()
      +process_input()
    }
    System <|-- InputSystem
    class InventoryRenderSystem {
      -renderer
      -logger
      -message_system
      -currently_selected_item_index
      -item_action_mode
      +initialize()
      +render_inventory()
      +render_equipment_section()
      +select_item()
      +show_item_actions()
      +handle_input()
      +draw_text()
      +draw_panel_border()
      +get_item_color()
      +get_item_display_string()
      +show_item_details()
    }
    class InventorySystem {
      -logger
      -message_system
      +initialize()
      +add_item()
      +remove_item()
      +use_item()
      +equip_item()
      +unequip_item()
      +drop_item()
      +item_name()
      +use_consumable()
      +toggle_equip()
      +log_message()
    }
    class ItemInteractionSystem {
      -inventory_system
      -message_system
      +initialize()
      +process_items_at_location()
      +pickup_item()
      +pickup_all_items()
      +find_items_at_position()
    }
    class MonsterSystem {
      -player
      -monsters
      -logger
      -rng
      +initialize()
      +spawn_monsters()
      +update()
      +monster_at()
      +player_collision?()
      +determine_monster_count()
      +spawn_monster()
      +find_spawn_location()
      +select_weighted_monster_type()
      +valid_move?()
    }
    System <|-- MonsterSystem
    class MovementSystem {
      -logger
      +initialize()
      +update()
      +process_entity_movement()
      +move()
      +can_process?()
      +normalize_direction()
      +get_target_cell()
      +can_move_to?()
      +handle_special_cell_attributes()
      +update_position()
      +log_movement()
    }
    System <|-- MovementSystem
    class RenderSystem {
      -renderer
      -difficulty
      -seed
      -logger
      +initialize()
      +update()
      +render_grid()
      +render_messages()
    }
    System <|-- RenderSystem
    class System {
      -world
      +initialize()
      +update()
      +handle_event()
      +entities_with()
      +emit_event()
      +queue_command()
    }
  end
  subgraph Others
    class AbstractAlgorithm {
    }
    class AldousBroder {
    }
    AbstractAlgorithm <|-- AldousBroder
    class BinaryTree {
    }
    AbstractAlgorithm <|-- BinaryTree
    class Dijkstra {
    }
    AbstractAlgorithm <|-- Dijkstra
    class LongestPath {
    }
    AbstractAlgorithm <|-- LongestPath
    class RecursiveBacktracker {
    }
    AbstractAlgorithm <|-- RecursiveBacktracker
    class RecursiveDivision {
      -grid
      +initialize()
      +process()
      +divide()
      +divide_horizontally()
      +divide_vertically()
    }
    AbstractAlgorithm <|-- RecursiveDivision
    class Command {
      -executed
      +initialize()
      +execute()
    }
    class ExitCommand {
      -logger
      +initialize()
      +execute()
    }
    Command <|-- ExitCommand
    class MoveCommand {
      -entity
      -direction
      -grid
      -movement_system
      -render_system
      -executed
      +initialize()
      +execute()
    }
    Command <|-- MoveCommand
    class NoOpCommand {
      -logger
      -reason
      +initialize()
      +execute()
    }
    class NullCommand {
      -executed
      +execute()
    }
    Command <|-- NullCommand
    class DisplayHandler {
      -keyboard_handler
      +initialize()
      +cleanup()
    }
    class Monster {
      -monster_type
      -health
      -damage
      +initialize()
      +alive?()
      +take_damage()
      +attack()
      +to_hash()
      +tile()
    }
    Entity <|-- Monster
    class Player {
      -name
      -level
      -experience
      -inventory
      +initialize()
      +gain_experience()
      +level_up()
      +add_to_inventory()
      +remove_from_inventory()
      +to_hash()
      +tile()
      +found_stairs?()
      +check_for_level_ups()
      +experience_to_next_level()
    }
    Entity <|-- Player
    class Stairs {
      +initialize()
    }
    Entity <|-- Stairs
    class EntityFactory {
    }
    class Event {
      -id
      -type
      -source
      -data
      -timestamp
      +initialize()
      +to_s()
      +to_h()
      +to_json()
      +safe_serialize()
    }
    class EventManager {
      -subscribers
      -logger
      -event_store
      +initialize()
      +subscribe()
      +unsubscribe()
      +publish()
      +publish_event()
      +query_events()
      +current_session()
      +close()
    }
    class EventVisualization {
      -event_store
      +initialize()
      +generate_timeline()
      +latest_session_id()
      +generate_html()
    }
    class EventStore {
      +store()
      +query()
      +load_session()
      +list_sessions()
      +close()
    }
    class FileEventStore {
      -directory
      -storage_path
      -current_session
      -current_file
      +initialize()
      +store()
      +query()
      +load_session()
      +list_sessions()
      +close()
      +ensure_file_open()
    }
    EventStore <|-- FileEventStore
    class Game {
      -difficulty
      -seed
      -logger
      -turn
      -world
      -display
      -level
      -player
      -monster_system
      +initialize()
      +start()
      +cleanup()
      +setup_world()
      +game_loop()
      +render()
      +input_to_direction()
    }
    class InputHandler {
      -logger
      -event_manager
      -render_system
      +initialize()
      +handle_input()
      +create_command()
    }
    class Item {
      -entity
      +initialize()
      +item_component()
      +name()
      +description()
      +stackable?()
      +type()
      +weight()
      +value()
      +stack_size()
      +equippable?()
      +equippable_component()
      +consumable?()
      +consumable_component()
      +use()
      +to_s()
    }
    class ItemFactory {
      -logger
      -character
      -color
      -layer
      -entity_type
      -tile
      +initialize()
      +create_item()
      +type()
      +create_weapon()
      +create_armor()
      +create_potion()
      +create_scroll()
      +determine_armor_slot()
    }
    class ItemRegistry {
      -logger
      -item_templates
      -item_factory
      +initialize()
      +register_template()
      +get_template()
      +create_item()
      +available_templates()
      +random_template_key()
      +create_random_item()
      +create_weapon_from_data()
      +create_armor_from_data()
      +create_potion_from_data()
      +create_scroll_from_data()
      +create_key_from_data()
      +create_currency_from_data()
      +create_misc_from_data()
      +load_default_templates()
    }
    class InventorySystemFacade {
      -logger
      -render_system
      -inventory_system
      -item_interaction_system
      -item_factory
      -item_registry
      -inventory_render_system
      -inventory_visible
      +initialize()
      +add_item_to_entity()
      +remove_item_from_entity()
      +use_item()
      +equip_item()
      +unequip_item()
      +drop_item()
      +check_for_items_at_position()
      +display_inventory()
      +hide_inventory()
      +inventory_visible?()
      +toggle_inventory_view()
      +handle_inventory_input()
      +cleanup()
    }
    class KeyboardHandler {
      +wait_for_input()
    }
    class Level {
      -grid
      -difficulty
      -entities
      -entrance_row
      -entrance_column
      -logger
      -algorithm
      -stairs
      +initialize()
      +generate()
      +place_stairs()
      +add_entity()
      +remove_entity()
      +all_entities()
      +update_grid_with_entity()
      +update_grid_with_entities()
    }
    class LevelGenerator {
      -logger
      -algorithm
      +generate()
      +ensure_path()
    }
    class Logger {
      -level
      -log_env
      -log_dir
      -log_file
      -file
      +initialize()
      +debug()
      +info()
      +warn()
      +error()
      +fatal()
      +close()
      +log()
    }
    class Map {
      -logger
      -rows
      -columns
      -algorithm
      +initialize()
      +create()
    }
    class Cell {
      -row
      -column
      -links
      -type_factory
      -cell_type
      -grid
      -tile
      +initialize()
      +position()
      +link()
      +unlink()
      +links()
      +linked?()
      +dead_end?()
      +player?()
      +stairs?()
      +neighbors()
      +tile=()
      +tile()
      +distances()
    }
    class CellType {
      -key
      -tile_character
      -properties
      +initialize()
      +walkable?()
      +stairs?()
      +player?()
      +to_s()
    }
    class CellTypeFactory {
      -types
      +initialize()
      +get_cell_type()
      +get_by_character()
      +register()
      +setup_standard_types()
    }
    class DistanceBetweenCells {
      -root
      -cells
      +initialize()
      +[]()
      +[]=()
      +cells()
      +path_to()
      +max()
    }
    class Grid {
      -rows
      -columns
      -grid
      +initialize()
      +[]()
      +each_cell()
      +random_cell()
      +size()
    }
    class Distances {
      -root
      -cells
      +initialize()
      +[]()
      +path_to()
      +cells()
      +max()
    }
    class Message {
      -content
      -category
      -importance
      -turn
      -timestamp
      -metadata
      -selectable
      -shortcut_key
      -selection_callback
      +initialize()
      +selectable?()
      +select()
      +has_shortcut?()
      +translated_text()
    }
    class MessageLog {
      -logger
      -messages
      -history_size
      -formatters
      -current_selection_index
      -observers
      +initialize()
      +add_observer()
      +remove_observer()
      +notify_observers()
      +current_game_turn()
      +add()
      +add_message()
      +get_by_category()
      +get_by_importance()
      +get_recent()
      +get_selectable_messages()
      +register_formatter()
      +clear()
      +register_default_formatters()
      +apply_formatters()
    }
    class MessageManager {
      -logger
      -render_system
      -message_log
      -panel
      -selection_mode
      -selection_index
      +initialize()
      +log_message()
      +log_translated()
      +add_message()
      +toggle_selection_mode()
      +handle_input()
      +currently_selected_message()
      +select_current_message()
      +setup_panel()
      +render()
      +get_recent_messages()
      +get_messages_by_category()
      +clear_messages()
      +log_combat()
      +log_movement()
      +log_item()
      +log_exploration()
      +log_warning()
      +log_critical()
      +log_success()
      +navigate_selection()
    }
    class MessagePanel {
      -x
      -y
      -width
      -height
      -message_log
      -scroll_offset
      +initialize()
      +update()
      +cleanup()
      +render()
      +scroll_up()
      +scroll_down()
      +render_message_object()
      +render_hash_message()
      +get_color_for_hash_message()
      +format_message_object()
      +format_hash_message()
      +draw_separator_line()
      +draw_message_count()
      +get_color_for_message()
    }
    class Renderer {
      +clear()
      +clear_screen()
      +draw_grid()
      +draw_character()
      +present()
    }
    class TerminalRenderer {
      +clear()
      +draw_grid()
      +draw_title_screen()
      +present()
    }
    class TileType {
    }
    class RenderSystemFactory {
      -renderer
      -logger
      +initialize()
      +render()
    }
    class ServiceRegistry {
    }
    class Scheduler {
      -entities
      +initialize()
      +register()
      +unregister()
      +update()
    }
    class ClassInfo {
      -name
      -parent
      -methods
      -instance_vars
      -dependencies
      -has_behavior
      -file
      +initialize()
    }
    class LogMonitor {
      -current_log
      -last_position
      -issues_detected
      -fixed_issues
      +initialize()
      +run()
      +find_latest_log()
      +read_new_log_entries()
      +analyze_log_content()
      +check_for_stack_trace()
      +display_status()
      +suggest_fix_for_event_serialization()
      +suggest_fix_for_level_transition()
    }
  end
  %% Relationships
  ConsumableComponent --> Component : uses
  CurrencyComponent --> Component : uses
  DurabilityComponent --> Component : uses
  EffectComponent --> Component : uses
  Entity --> Component : uses
  EquippableComponent --> Component : uses
  InputComponent --> Component : uses
  InventoryComponent --> Component : uses
  ItemComponent --> Component : uses
  KeyComponent --> Component : uses
  MovementComponent --> Component : uses
  PositionComponent --> Component : uses
  RenderComponent --> Component : uses
  StairsComponent --> Component : uses
  TileComponent --> Component : uses
  Monster --> PositionComponent : uses
  Monster --> MovementComponent : uses
  Monster --> RenderComponent : uses
  Player --> PositionComponent : uses
  Player --> MovementComponent : uses
  Player --> TileComponent : uses
  Player --> StairsComponent : uses
  Player --> RenderComponent : uses
  Stairs --> PositionComponent : uses
  Stairs --> RenderComponent : uses
  EntityFactory --> Entity : uses
  EntityFactory --> PositionComponent : uses
  EntityFactory --> RenderComponent : uses
  EntityFactory --> InputComponent : uses
  EntityFactory --> MovementComponent : uses
  EventManager --> Event : uses
  FileEventStore --> Event : uses
  Game --> EntityFactory : uses
  InputHandler --> MoveCommand : uses
  InputHandler --> ExitCommand : uses
  InputHandler --> NullCommand : uses
  ItemFactory --> Entity : uses
  ItemFactory --> ItemComponent : uses
  ItemFactory --> EquippableComponent : uses
  ItemFactory --> ConsumableComponent : uses
  ItemRegistry --> ItemFactory : uses
  ItemRegistry --> KeyComponent : uses
  ItemRegistry --> CurrencyComponent : uses
  InventorySystemFacade --> ItemFactory : uses
  InventorySystemFacade --> ItemRegistry : uses
  Level --> EntityFactory : uses
  LevelGenerator --> Level : uses
  Logger --> Logger : uses
  Map --> Logger : uses
  Cell --> Cell : uses
  CellTypeFactory --> CellType : uses
  DistanceBetweenCells --> DistanceBetweenCells : uses
  Grid --> Cell : uses
  Distances --> Cell : uses
  Distances --> Distances : uses
  MessageLog --> Message : uses
  MessageManager --> MessageLog : uses
  MessageManager --> Message : uses
  CollisionSystem --> Logger : uses
  CollisionSystem --> World :  emits_entities_collided
  CollisionSystem --> World :  emits_level_transition_requested
  CollisionSystem --> World :  emits_item_picked_up
  CollisionSystem --> World :  queues_add_to_inventory
  CollisionSystem --> World :  queues_remove_entity
  InputSystem --> Logger : uses
  InventorySystem --> PositionComponent : uses
  MonsterSystem --> Logger : uses
  MonsterSystem --> EntityFactory : uses
  MonsterSystem --> TileType : uses
  MovementSystem --> Logger : uses
  MovementSystem --> TileType : uses
  MovementSystem --> World :  emits_entity_moved
  MovementSystem --> World :  emits_stairs_found
  MovementSystem --> World :  queues_change_level
  RenderSystem --> TerminalRenderer : uses
  RenderSystem --> Logger : uses
  RenderSystemFactory --> RenderSystem : uses
  RenderSystemFactory --> RenderSystemFactory : uses
  RenderSystemFactory --> TerminalRenderer : uses
  RenderSystemFactory --> Logger : uses
  World --> DisplayHandler : uses
  World --> LevelGenerator : uses
  World --> World :  emits_level_transitioned
  ServiceRegistry --> ServiceRegistry : uses
  ServiceRegistry --> Game : uses
  Scheduler --> ServiceRegistry : uses
  Scheduler --> Game : uses
  ClassInfo --> ClassInfo : uses
  LogMonitor --> LogMonitor : uses
  TestPositionComponent --> Component : uses
  Entity o--> "many" Component : contains
  World o--> "many" Entity : manages
  World o--> "many" System : manages
